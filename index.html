<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0d0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>GetHoustons ‚Äî Reservation Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0f14;--s1:#1a1d25;--s2:#16181f;
  --border:#ffffff10;--border2:#ffffff08;
  --text:#e8e4dc;--dim:#888;--dim2:#666;--dim3:#555;
  --gold:#b8956a;--gold-light:#dfc08a;--gold-bg:#b8956a25;--gold-border:#b8956a33;--gold-glow:#b8956a15;
  --green:#5ec98b;--green-dark:#2d8a5e;--green-bg:#2d8a5e1a;--green-border:#2d8a5e33;
  --red:#ff6347;--red-bg:#ff634718;
  --radius:14px;--radius-sm:10px;
}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{color:var(--gold);text-decoration:none}
a:hover{text-decoration:underline}

/* Location Picker */
.loc-picker{max-width:560px;margin:0 auto;padding:16px 24px 0}
.loc-picker select{
  width:100%;padding:12px 16px;font-size:15px;font-weight:600;font-family:inherit;
  background:var(--s1);color:var(--gold-light);border:1px solid var(--gold-border);
  border-radius:var(--radius-sm);cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23b8956a' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 16px center;
}
.loc-picker select:hover{border-color:var(--gold)}
.loc-picker select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-glow)}
.loc-detect{font-size:11px;color:var(--dim);margin-top:6px;text-align:center}
.loc-detect span{color:var(--gold);cursor:pointer}
.loc-detect span:hover{text-decoration:underline}

/* Header */
.header{text-align:center;padding:24px 24px 32px;position:relative}
.header-eyebrow{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);font-weight:700;margin-bottom:8px}
.header h1{font-size:28px;font-weight:700}
.header h1 span{font-weight:300}
.header-sub{color:var(--dim);font-size:14px;margin-top:6px}

/* Auth corner */
.auth-corner{position:fixed;top:16px;right:16px;z-index:100}
.btn-auth{
  background:var(--s1);border:1px solid var(--border);border-radius:10px;
  padding:8px 16px;color:var(--dim);font-size:13px;font-weight:500;cursor:pointer;
  font-family:inherit;transition:all .2s;
}
.btn-auth:hover,.btn-auth.logged-in{border-color:var(--gold-border);color:var(--gold-light)}
.auth-dropdown{
  position:absolute;top:calc(100% + 8px);right:0;width:280px;
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.5);display:none;
}
.auth-dropdown.open{display:block}
.auth-dropdown h3{font-size:15px;margin-bottom:12px}
.auth-dropdown input{
  width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;
  margin-bottom:8px;outline:none;
}
.auth-dropdown input:focus{border-color:var(--gold-border)}
.auth-dropdown .auth-btn{
  width:100%;padding:10px;border:none;border-radius:8px;
  background:linear-gradient(135deg,var(--gold),#9a7a52);color:var(--bg);
  font-weight:600;font-size:14px;cursor:pointer;margin-top:4px;
}
.auth-toggle{font-size:12px;color:var(--dim);text-align:center;margin-top:10px;cursor:pointer}
.auth-toggle strong{color:var(--gold)}
.auth-error{color:var(--red);font-size:12px;display:none;margin-top:6px}
.auth-user-view{display:none}
.auth-user-name{font-weight:600;font-size:15px}
.auth-user-email{font-size:12px;color:var(--dim);margin-bottom:12px}
.auth-logout{
  width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;
  background:none;color:var(--dim);font-size:13px;cursor:pointer;font-family:inherit;
}
.user-alerts-list{margin-top:12px}
.user-alert-item{font-size:12px;padding:8px;background:var(--bg);border-radius:6px;margin-bottom:4px}

/* Hero */
.hero{
  max-width:560px;margin:0 auto 32px;
  background:linear-gradient(135deg,var(--s1),var(--s2));
  border:1px solid var(--gold-border);border-radius:16px;padding:32px;text-align:center;
  position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle at 50% 50%,#b8956a08,transparent 60%);pointer-events:none;
}
.hero-eyebrow{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:8px;position:relative}
.hero-time{font-size:36px;font-weight:700;color:var(--gold-light);margin-bottom:4px;position:relative}
.hero-detail{font-size:15px;color:#aaa;margin-bottom:20px;position:relative}
.hero-btn{
  display:inline-block;background:linear-gradient(135deg,var(--gold),#9a7a52);
  color:var(--bg);padding:14px 36px;border-radius:10px;font-weight:600;
  font-size:15px;cursor:pointer;border:none;position:relative;transition:filter .2s;
  font-family:inherit;
}
.hero-btn:hover{filter:brightness(1.1)}
.hero-alt{margin-top:14px;font-size:13px;color:var(--dim2);position:relative}
.hero-alt a{color:var(--gold);text-decoration:none;cursor:pointer}
.hero-loading{color:var(--dim);font-size:14px;position:relative}

/* Scan bar */
.scan-bar{max-width:560px;margin:0 auto 24px;padding:0 24px;display:flex;justify-content:space-between;align-items:center}
.scan-label{font-size:12px;color:var(--dim3)}
.scan-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:6px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Controls */
.controls{max-width:560px;margin:0 auto;padding:0 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px}
.party-sel{display:flex;gap:6px}
.party-btn{
  background:var(--s1);border:1px solid var(--border);color:var(--dim);
  width:40px;height:40px;border-radius:8px;font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:inherit;
}
.party-btn.active{border-color:var(--gold);color:var(--gold-light);background:var(--gold-glow)}
.loc-legend{display:flex;gap:14px}
.loc-dot{display:flex;align-items:center;gap:5px;font-size:13px;color:var(--dim)}
.loc-dot .dot{width:8px;height:8px;border-radius:50%}
.dot.pt-dot{background:var(--gold-light)}
.dot.wp-dot{background:var(--green)}

/* Week tabs */
.week-tabs{max-width:560px;margin:0 auto 16px;padding:0 24px;display:flex;gap:6px}
.week-tab{
  flex:1;padding:10px 0;border-radius:10px;font-size:13px;font-weight:600;
  text-align:center;cursor:pointer;transition:all .25s;font-family:inherit;
  background:var(--s1);border:1px solid var(--border);color:var(--dim);
}
.week-tab:hover{border-color:var(--gold-border);color:var(--gold-light)}
.week-tab.active{background:var(--gold-glow);border-color:var(--gold);color:var(--gold-light)}

/* Cards container */
.cards{max-width:560px;margin:0 auto;padding:0 24px 48px;display:flex;flex-direction:column;gap:12px;transition:opacity .25s}

/* Day card */
.day-card{
  background:linear-gradient(135deg,var(--s1),var(--s2));
  border:1px solid var(--border2);border-radius:var(--radius);padding:20px 22px;
  transition:all .2s;
}
.day-card:hover{border-color:var(--gold-border)}
.day-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.day-name{font-size:18px;font-weight:600}
.day-date{color:var(--dim2);font-size:14px;font-weight:400;margin-left:6px}
.day-badge{
  background:var(--gold-glow);color:var(--gold);padding:4px 12px;border-radius:20px;
  font-size:12px;font-weight:600;white-space:nowrap;
}
.day-badge.hot{background:var(--red-bg);color:var(--red)}
.day-badge.sold-out{background:#ff634712;color:#ff634788}

.time-section{margin-bottom:10px}
.time-section:last-child{margin-bottom:0}
.time-label{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim2);margin-bottom:6px}
.time-pills{display:flex;flex-wrap:wrap;gap:6px}
.pill{
  padding:6px 13px;border-radius:8px;font-size:13px;font-weight:500;
  cursor:pointer;transition:all .15s;border:1px solid transparent;
}
.pill:hover{transform:scale(1.05);filter:brightness(1.2)}
.pill.pt{background:var(--gold-bg);color:var(--gold-light);border-color:var(--gold-border)}
.pill.wp{background:var(--green-bg);color:var(--green);border-color:var(--green-border)}

.no-slots{color:var(--dim3);font-size:13px;font-style:italic;text-align:center;margin-top:4px}

/* Alerts styles removed */

/* Booking Modal */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;
  display:none;align-items:center;justify-content:center;padding:24px;
}
.modal-overlay.open{display:flex}
.modal-content{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:28px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto;
}
.modal-header{margin-bottom:20px}
.modal-header h3{font-size:18px;font-weight:700;margin-bottom:4px}
.modal-header .modal-loc{color:var(--gold-light);font-size:15px}
.modal-header .modal-datetime{color:var(--dim);font-size:14px}
.modal-header .modal-party{color:var(--dim);font-size:13px;margin-top:2px}
.modal-form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-form label{
  display:block;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--dim);font-weight:700;margin-bottom:4px;
}
.modal-form input{
  width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;outline:none;
}
.modal-form input:focus{border-color:var(--gold-border)}
.modal-error{color:var(--red);font-size:12px;display:none;margin-top:10px;grid-column:1/-1}
.modal-success{display:none;text-align:center;padding:20px;grid-column:1/-1}
.modal-success .check{font-size:2.5rem;margin-bottom:8px}
.modal-success h3{color:var(--green);margin-bottom:4px}
.modal-success p{color:var(--dim);font-size:13px}
.modal-actions{display:flex;gap:10px;margin-top:16px;grid-column:1/-1}
.modal-cancel{
  flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;
  background:none;color:var(--dim);font-size:14px;cursor:pointer;font-family:inherit;
}
.modal-submit{
  flex:2;padding:12px;border:none;border-radius:8px;
  background:linear-gradient(135deg,var(--gold),#9a7a52);color:var(--bg);
  font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;
}
.modal-submit:disabled{opacity:.5;cursor:not-allowed}

/* Feedback floating button */
.feedback-fab{
  position:fixed;bottom:24px;right:24px;z-index:90;
  background:linear-gradient(135deg,var(--s1),var(--s2));border:1px solid var(--border);
  border-radius:50px;padding:12px 20px;color:var(--dim);font-size:13px;font-weight:500;
  cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:6px;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
}
.feedback-fab:hover{border-color:var(--gold-border);color:var(--gold-light)}

/* Feedback modal */
.feedback-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;
  display:none;align-items:center;justify-content:center;padding:24px;
}
.feedback-overlay.open{display:flex}
.feedback-modal{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:28px;max-width:440px;width:100%;
}
.feedback-modal h3{font-size:18px;font-weight:700;margin-bottom:4px}
.feedback-modal .fb-sub{color:var(--dim);font-size:14px;margin-bottom:20px}
.feedback-modal textarea{
  width:100%;min-height:120px;padding:12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;outline:none;resize:vertical;
}
.feedback-modal textarea:focus{border-color:var(--gold-border)}
.feedback-modal .fb-contact{
  width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;outline:none;margin-top:10px;
}
.feedback-modal .fb-contact:focus{border-color:var(--gold-border)}
.feedback-modal .fb-actions{display:flex;gap:10px;margin-top:16px}
.fb-cancel{
  flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;
  background:none;color:var(--dim);font-size:14px;cursor:pointer;font-family:inherit;
}
.fb-submit{
  flex:2;padding:12px;border:none;border-radius:8px;
  background:linear-gradient(135deg,var(--gold),#9a7a52);color:var(--bg);
  font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;
}
.fb-submit:disabled{opacity:.5;cursor:not-allowed}

/* Toast */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:300;
  background:var(--s1);border:1px solid var(--gold-border);border-radius:10px;
  padding:12px 24px;color:var(--gold-light);font-size:14px;font-weight:500;
  box-shadow:0 4px 20px rgba(0,0,0,.5);opacity:0;transition:opacity .3s;pointer-events:none;
}
.toast.show{opacity:1}
.toast.error{border-color:var(--red);color:var(--red)}

/* Google auth user */
.auth-avatar{width:32px;height:32px;border-radius:50%;margin-right:8px;vertical-align:middle}
.auth-google-btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;
  background:var(--bg);color:var(--text);font-size:14px;cursor:pointer;font-family:inherit;
  transition:all .2s;
}
.auth-google-btn:hover{border-color:var(--gold-border);background:#1a1d25}
.auth-google-btn svg{width:18px;height:18px}
.auth-divider{text-align:center;color:var(--dim2);font-size:12px;margin:12px 0;position:relative}
.auth-divider::before,.auth-divider::after{content:'';position:absolute;top:50%;width:40%;height:1px;background:var(--border)}
.auth-divider::before{left:0}
.auth-divider::after{right:0}

/* Watch modal */
.watch-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;
  display:none;align-items:center;justify-content:center;padding:24px;
}
.watch-overlay.open{display:flex}
.watch-modal{
  background:var(--s1);border:1px solid var(--border);border-radius:var(--radius);
  padding:28px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto;
}
.watch-modal h3{font-size:18px;font-weight:700;margin-bottom:4px}
.watch-modal .wm-sub{color:var(--dim);font-size:14px;margin-bottom:20px}
.watch-form-row{display:flex;gap:12px;margin-bottom:12px}
.watch-form-row label{display:block;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);font-weight:700;margin-bottom:4px}
.watch-form-row input,.watch-form-row select{
  width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;outline:none;
}
.watch-form-row input:focus,.watch-form-row select:focus{border-color:var(--gold-border)}
.watch-auto-toggle{display:flex;align-items:center;gap:10px;margin:12px 0;padding:12px;background:var(--bg);border-radius:8px;cursor:pointer}
.watch-auto-toggle input[type=checkbox]{accent-color:var(--gold);width:18px;height:18px}
.watch-auto-toggle .toggle-label{font-size:14px;font-weight:500}
.watch-auto-toggle .toggle-note{font-size:11px;color:var(--dim);margin-top:2px}
.watch-book-fields{display:none;margin-bottom:12px}
.watch-book-fields.show{display:block}
.watch-actions{display:flex;gap:10px;margin-top:16px}
.watch-cancel{
  flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;
  background:none;color:var(--dim);font-size:14px;cursor:pointer;font-family:inherit;
}
.watch-submit{
  flex:2;padding:12px;border:none;border-radius:8px;
  background:linear-gradient(135deg,var(--gold),#9a7a52);color:var(--bg);
  font-weight:600;font-size:14px;cursor:pointer;font-family:inherit;
}
.watch-submit:disabled{opacity:.5;cursor:not-allowed}

/* Watch button on sold out cards */
.watch-btn{
  display:inline-flex;align-items:center;gap:4px;padding:6px 14px;
  background:var(--gold-glow);border:1px solid var(--gold-border);border-radius:8px;
  color:var(--gold-light);font-size:12px;font-weight:600;cursor:pointer;
  font-family:inherit;transition:all .2s;margin-top:8px;
}
.watch-btn:hover{background:var(--gold-bg);border-color:var(--gold)}

/* My Watches section */
.my-watches{max-width:560px;margin:0 auto;padding:0 24px 24px;display:none}
.my-watches h3{font-size:16px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.watch-item{
  background:linear-gradient(135deg,var(--s1),var(--s2));border:1px solid var(--border2);
  border-radius:var(--radius-sm);padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;
}
.watch-item-info{font-size:13px}
.watch-item-loc{font-weight:600;margin-bottom:2px}
.watch-item-detail{color:var(--dim);font-size:12px}
.watch-item-badge{font-size:11px;padding:3px 8px;border-radius:12px;background:var(--gold-glow);color:var(--gold)}
.watch-item-cancel{
  background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;
  color:var(--dim);font-size:11px;cursor:pointer;font-family:inherit;
}
.watch-item-cancel:hover{border-color:var(--red);color:var(--red)}

/* Admin feedback list */
.admin-feedback{max-width:560px;margin:0 auto;padding:0 24px 32px;display:none}
.admin-feedback .fb-item{
  background:linear-gradient(135deg,var(--s1),var(--s2));border:1px solid var(--border2);
  border-radius:var(--radius-sm);padding:16px;margin-bottom:8px;
}
.admin-feedback .fb-msg{font-size:14px;line-height:1.5;margin-bottom:8px}
.admin-feedback .fb-meta{font-size:11px;color:var(--dim2);display:flex;gap:12px;flex-wrap:wrap}

/* Notify Section */
.notify-section{max-width:560px;margin:0 auto;padding:0 24px 32px}
.notify-card{
  background:#141419;border:1px solid #2a2a3a;border-radius:12px;padding:28px;
}
.notify-card h2{font-size:20px;font-weight:700;margin-bottom:4px}
.notify-card .notify-sub{color:var(--dim);font-size:14px;margin-bottom:20px}
.notify-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.notify-grid label{display:block;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);font-weight:700;margin-bottom:4px}
.notify-grid select,.notify-grid input[type="date"]{
  width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;outline:none;
  appearance:none;-webkit-appearance:none;
}
.notify-grid select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;
}
.notify-grid select:focus,.notify-grid input:focus{border-color:var(--gold-border)}
/* Time Pills */
.time-pills-container{grid-column:1/-1}
.time-pills-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.time-pill{
  padding:8px 16px;display:flex;align-items:center;justify-content:center;
  border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;
  background:#1a1a2e;border:1px solid #2a2a3a;color:var(--dim);
  transition:all .15s;user-select:none;white-space:nowrap;
}
.time-pill:hover{border-color:#555;color:var(--text)}
.time-pill.in-range{background:#d4a843;color:#111;border-color:#d4a843;font-weight:600;box-shadow:0 0 8px #d4a84333}
.notify-toggle{
  display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg);
  border-radius:8px;margin-bottom:20px;cursor:pointer;user-select:none;overflow:visible;
}
.notify-toggle .toggle-text{font-size:14px;font-weight:500;flex:1}
.toggle-switch{
  width:44px;height:24px;background:#333;border-radius:12px;position:relative;
  transition:background .2s;flex-shrink:0;
}
.toggle-switch::after{
  content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
  background:#888;border-radius:50%;transition:all .2s;
}
.toggle-switch.on{background:#2d8a5e}
.toggle-switch.on::after{left:23px;background:#5ec98b}
.notify-cta{
  width:100%;padding:14px;border:none;border-radius:10px;
  background:linear-gradient(135deg,#d4a843,#b8956a);color:var(--bg);
  font-weight:700;font-size:16px;cursor:pointer;font-family:inherit;transition:filter .2s;
}
.notify-cta:hover{filter:brightness(1.1)}
.notify-cta:disabled{opacity:.5;cursor:not-allowed}
.notify-footer{text-align:center;color:var(--dim2);font-size:12px;margin-top:10px}

/* My Watches v2 */
.watches-section{max-width:560px;margin:0 auto;padding:0 24px 32px;display:none}
.watches-section h3{font-size:18px;font-weight:600;margin-bottom:14px}
.watch-card{
  background:#141419;border:1px solid #2a2a3a;border-radius:10px;padding:16px;
  margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;
}
.watch-card-info{flex:1}
.watch-card-loc{font-weight:600;font-size:14px;margin-bottom:2px}
.watch-card-detail{color:var(--dim);font-size:12px}
.watch-card-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.watch-status{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600;padding:4px 10px;border-radius:12px}
.watch-status.watching{background:#2d8a5e1a;color:var(--green)}
.watch-status.booked{background:var(--gold-glow);color:var(--gold-light)}
.watch-status.expired{background:#ffffff08;color:var(--dim2)}
.watch-pulse{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
.watch-autobook-badge{font-size:10px;padding:3px 8px;border-radius:10px;background:var(--gold-glow);color:var(--gold);white-space:nowrap}
.watch-card-cancel{
  background:none;border:1px solid var(--border);border-radius:6px;width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:14px;
  cursor:pointer;font-family:inherit;transition:all .2s;
}
.watch-card-cancel:hover{border-color:var(--red);color:var(--red)}

@media(max-width:480px){
  .notify-grid{grid-template-columns:1fr}
}

/* Footer */
footer{text-align:center;padding:24px;color:#444;font-size:13px}

/* Loading skeleton */
.skeleton{background:linear-gradient(90deg,var(--s1) 25%,var(--s2) 50%,var(--s1) 75%);background-size:200%;animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{background-position:200%}100%{background-position:-200%}}
.card-skeleton{height:120px;border-radius:var(--radius);margin-bottom:12px}

@media(max-width:480px){
  .modal-form{grid-template-columns:1fr}
  .hero-time{font-size:28px}
}
</style>
</head>
<body>

<!-- Auth Corner -->
<div class="auth-corner" id="auth-corner">
  <button class="btn-auth" id="btn-auth" onclick="toggleAuthModal()">üë§ Sign In</button>
  <div class="auth-dropdown" id="auth-dropdown">
    <div id="auth-form-view">
      <h3 id="auth-title">Sign In</h3>
      <div id="g_id_onload"
           data-client_id="23317478020-ertd12jqki1bus53piflgomlu6ctipjn.apps.googleusercontent.com"
           data-callback="handleGoogleSignIn"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="filled_black"
           data-text="signin_with"
           data-size="large"
           data-logo_alignment="left"
           data-width="240">
      </div>
      <div class="auth-divider">or</div>
      <div id="auth-name-field" style="display:none">
        <input type="text" id="auth-name" placeholder="Your name">
      </div>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-password" placeholder="Password">
      <button class="auth-btn" id="auth-submit-btn" onclick="submitAuth()">Sign In</button>
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-toggle" id="auth-toggle" onclick="toggleAuthMode()">Don't have an account? <strong>Sign up</strong></div>
    </div>
    <div class="auth-user-view" id="auth-user-view">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <img class="auth-avatar" id="auth-avatar" src="" alt="" style="display:none">
        <div>
          <div class="auth-user-name" id="auth-user-name"></div>
          <div class="auth-user-email" id="auth-user-email"></div>
        </div>
      </div>
      <div id="user-alerts-list"></div>
      <button class="auth-logout" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
</div>

<!-- Location Picker -->
<div class="loc-picker">
  <select id="loc-select" onchange="changeLocation(this.value)" style="width:100%">
    <option value="">Location...</option>
  </select>
  <div class="loc-detect" id="loc-detect"></div>
</div>

<!-- Header -->
<div class="header">
  <div class="header-eyebrow" id="header-eyebrow">GetHoustons</div>
  <h1>Reservation <span>Tracker</span></h1>
  <div class="header-sub" id="header-sub">Houston's, Hillstone & more ‚Äî real-time availability</div>
</div>

<!-- Hero: Next Available -->
<div class="hero" id="hero-card">
  <div class="hero-loading">Loading availability...</div>
</div>

<!-- Info banner -->
<div style="max-width:560px;margin:0 auto 16px;padding:0 24px">
  <div style="background:#b8956a12;border:1px solid #b8956a22;border-radius:10px;padding:14px 18px;font-size:13px;color:#aaa;line-height:1.5">
    üìã We track <strong style="color:#dfc08a">Lunch (12‚Äì1 PM)</strong> and <strong style="color:#dfc08a">Dinner (6‚Äì8 PM)</strong> ‚Äî the prime-time slots that are hardest to get. We scan availability in real time so you can see what's open at a glance.
  </div>
</div>

<!-- Scan status -->
<div class="scan-bar">
  <div class="scan-label" id="scan-status"><span class="scan-dot"></span>Scanning...</div>
</div>

<!-- Controls -->
<div class="controls">
  <div class="party-sel" id="party-sel">
    <button class="party-btn active" onclick="changeParty(2)">2</button>
    <button class="party-btn" onclick="changeParty(3)">3</button>
    <button class="party-btn" onclick="changeParty(4)">4</button>
  </div>
  <div class="loc-legend" id="loc-legend"></div>
</div>

<!-- Week Tabs -->
<div class="week-tabs" id="week-tabs"></div>

<!-- Day Cards -->
<div class="cards" id="day-cards">
  <div class="card-skeleton skeleton"></div>
  <div class="card-skeleton skeleton"></div>
  <div class="card-skeleton skeleton"></div>
</div>

<!-- Get Notified Section -->
<div class="notify-section">
  <div class="notify-card">
    <h2>üîî Get Notified When Slots Open</h2>
    <div class="notify-sub">We'll check every 30 minutes and notify you by email when a slot opens</div>
    <div class="notify-grid">
      <div>
        <label>Location</label>
        <select id="notify-location"></select>
      </div>
      <div>
        <label>Party Size</label>
        <select id="notify-party">
          <option value="2">2 guests</option>
          <option value="3">3 guests</option>
          <option value="4">4 guests</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input type="date" id="notify-date" style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:14px;-webkit-appearance:none;cursor:pointer;color-scheme:dark">
      </div>
      <div class="time-pills-container">
        <label>Time Window</label>
        <div class="time-pills-grid">
          <button type="button" class="time-pill" data-start="11:00" data-end="13:00" onclick="selectTimePill(this)">Lunch 11‚Äì1</button>
          <button type="button" class="time-pill in-range" data-start="18:00" data-end="20:00" onclick="selectTimePill(this)">Dinner 6‚Äì8</button>
          <button type="button" class="time-pill" data-start="20:00" data-end="22:00" onclick="selectTimePill(this)">Late 8‚Äì10</button>
          <button type="button" class="time-pill" data-start="11:00" data-end="22:00" onclick="selectTimePill(this)">Any Time</button>
        </div>
      </div>
    </div>
    <div class="notify-toggle" onclick="toggleNotifyAutoBook()">
      <span class="toggle-text">üì≤ Automatically book when available</span>
      <div class="toggle-switch" id="notify-auto-toggle"></div>
    </div>
    <button class="notify-cta" id="notify-cta" onclick="submitNotifyWatch()">Start Watching</button>
    <div class="notify-footer">We'll check every 30 minutes and notify you by email</div>
  </div>
</div>

<!-- My Watches Section v2 -->
<div class="watches-section" id="watches-section">
  <h3>üëÄ My Watches</h3>
  <div id="watches-list"></div>
</div>

<!-- Admin Feedback View -->
<div class="admin-feedback" id="admin-feedback">
  <h3 style="font-size:18px;font-weight:600;margin-bottom:16px">üì¨ Feedback Submissions</h3>
  <div id="admin-feedback-list"></div>
</div>

<!-- old my-watches removed -->

<!-- Watch Modal -->
<div class="watch-overlay" id="watch-modal">
  <div class="watch-modal">
    <h3>üëÄ Watch This Slot</h3>
    <div class="wm-sub">We'll notify you when a reservation opens up.</div>
    <div class="watch-form-row">
      <div style="flex:1">
        <label>Location</label>
        <select id="watch-location" style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:14px"></select>
      </div>
    </div>
    <div class="watch-form-row">
      <div style="flex:1">
        <label>Date</label>
        <input type="date" id="watch-date">
      </div>
      <div style="flex:1">
        <label>Party Size</label>
        <select id="watch-party">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
    </div>
    <div class="watch-form-row">
      <div style="flex:1">
        <label>From</label>
        <select id="watch-time-start">
          <option value="11:00">11:00 AM</option>
          <option value="12:00">12:00 PM</option>
          <option value="13:00">1:00 PM</option>
          <option value="17:00">5:00 PM</option>
          <option value="18:00" selected>6:00 PM</option>
          <option value="19:00">7:00 PM</option>
          <option value="20:00">8:00 PM</option>
        </select>
      </div>
      <div style="flex:1">
        <label>To</label>
        <select id="watch-time-end">
          <option value="13:00">1:00 PM</option>
          <option value="14:00">2:00 PM</option>
          <option value="19:00">7:00 PM</option>
          <option value="20:00" selected>8:00 PM</option>
          <option value="21:00">9:00 PM</option>
          <option value="22:00">10:00 PM</option>
        </select>
      </div>
    </div>
    <label class="watch-auto-toggle" onclick="toggleAutoBook()">
      <input type="checkbox" id="watch-auto-book">
      <div>
        <div class="toggle-label">Auto-book when available</div>
        <div class="toggle-note">We'll automatically reserve a table for you</div>
      </div>
    </label>
    <div class="watch-book-fields" id="watch-book-fields">
      <div class="watch-form-row">
        <div style="flex:1">
          <label>First Name</label>
          <input type="text" id="watch-first" placeholder="First name">
        </div>
        <div style="flex:1">
          <label>Last Name</label>
          <input type="text" id="watch-last" placeholder="Last name">
        </div>
      </div>
      <div class="watch-form-row">
        <div style="flex:1">
          <label>Phone</label>
          <input type="tel" id="watch-phone" placeholder="(404) 555-1234">
        </div>
      </div>
    </div>
    <div class="watch-actions">
      <button class="watch-cancel" onclick="closeWatchModal()">Cancel</button>
      <button class="watch-submit" id="watch-submit" onclick="submitWatch()">Start Watching</button>
    </div>
  </div>
</div>

<!-- Feedback FAB -->
<button class="feedback-fab" onclick="openFeedbackModal()">üí¨ Feedback</button>

<!-- Feedback Modal -->
<div class="feedback-overlay" id="feedback-modal">
  <div class="feedback-modal">
    <h3>Send Feedback</h3>
    <div class="fb-sub">Got ideas, bugs, or love? Let us know.</div>
    <textarea id="fb-message" placeholder="What's on your mind?"></textarea>
    <input class="fb-contact" id="fb-contact" placeholder="Email or contact (optional)">
    <div class="fb-actions">
      <button class="fb-cancel" onclick="closeFeedbackModal()">Cancel</button>
      <button class="fb-submit" id="fb-submit" onclick="submitFeedback()">Send</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Footer -->
<footer>
  <p>Built with üçü by Lee Chips</p>
  <p style="margin-top:4px">Not affiliated with Hillstone Restaurant Group ¬∑ <span id="footer-year"></span></p>
</footer>

<!-- Booking Modal -->
<div class="modal-overlay" id="book-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Book a Table</h3>
      <div class="modal-loc" id="book-modal-loc"></div>
      <div class="modal-datetime" id="book-modal-datetime"></div>
      <div class="modal-party" id="book-modal-party"></div>
    </div>
    <div class="modal-form" id="book-form">
      <div>
        <label>First Name</label>
        <input type="text" id="book-first" placeholder="First name">
      </div>
      <div>
        <label>Last Name</label>
        <input type="text" id="book-last" placeholder="Last name">
      </div>
      <div>
        <label>Email</label>
        <input type="email" id="book-email" placeholder="you@email.com">
      </div>
      <div>
        <label>Phone</label>
        <input type="tel" id="book-phone" placeholder="(404) 555-1234">
      </div>
      <div class="modal-error" id="book-error"></div>
      <div class="modal-success" id="book-success">
        <div class="check">üéâ</div>
        <h3>Reservation Confirmed!</h3>
        <p id="book-success-msg"></p>
      </div>
      <div class="modal-actions" id="book-actions">
        <button class="modal-cancel" onclick="closeBookModal()">Cancel</button>
        <button class="modal-submit" id="book-submit-btn" onclick="submitBooking()">Book Now</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== TIME PILLS ===== */
window._notifyTimeStart = '18:00';
window._notifyTimeEnd = '20:00';

function selectTimePill(el){
  document.querySelectorAll('.time-pills-grid .time-pill').forEach(p => p.classList.remove('in-range'));
  el.classList.add('in-range');
  window._notifyTimeStart = el.dataset.start;
  window._notifyTimeEnd = el.dataset.end;
}

/* ===== CONFIG ===== */
let LOCATIONS = {};
let allLocations = []; // from /api/locations
let currentLocationKeys = []; // which location keys are currently active

let scanData = null;
let scanTime = null;
let partySize = 2;
let currentWeek = 0;

/* ===== PROXIMITY GROUPING ===== */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8; // Earth radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function buildProximityGroups(locs) {
  // locs: array of location objects with lat, lon, key, city, state
  // Returns array of groups: [{id, label, keys}]
  if (!locs || locs.length < 2) return [];
  
  const THRESHOLD = 30; // miles
  // Build adjacency: which locations are within threshold of each other
  const adj = {};
  locs.forEach(l => { adj[l.key] = new Set(); });
  for (let i = 0; i < locs.length; i++) {
    for (let j = i+1; j < locs.length; j++) {
      if (locs[i].lat && locs[i].lon && locs[j].lat && locs[j].lon) {
        const d = haversine(locs[i].lat, locs[i].lon, locs[j].lat, locs[j].lon);
        if (d <= THRESHOLD) {
          adj[locs[i].key].add(locs[j].key);
          adj[locs[j].key].add(locs[i].key);
        }
      }
    }
  }
  
  // Find connected components (clusters) via BFS
  const visited = new Set();
  const clusters = [];
  for (const l of locs) {
    if (visited.has(l.key) || adj[l.key].size === 0) continue;
    const cluster = [];
    const queue = [l.key];
    while (queue.length) {
      const k = queue.shift();
      if (visited.has(k)) continue;
      visited.add(k);
      cluster.push(k);
      for (const neighbor of adj[k]) {
        if (!visited.has(neighbor)) queue.push(neighbor);
      }
    }
    if (cluster.length >= 2) clusters.push(cluster);
  }
  
  // Generate labels for each cluster
  const locMap = {};
  locs.forEach(l => { locMap[l.key] = l; });
  
  return clusters.map(keys => {
    // Find most common city
    const cityCounts = {};
    keys.forEach(k => {
      const city = locMap[k].city || '';
      cityCounts[city] = (cityCounts[city] || 0) + 1;
    });
    const cities = Object.keys(cityCounts);
    let label;
    if (cities.length === 1) {
      label = cities[0];
    } else {
      // If most cities are different, try to find a regional name
      const topCity = cities.sort((a,b) => cityCounts[b] - cityCounts[a])[0];
      const state = locMap[keys[0]].state;
      // Check for known regional groupings
      const allCities = keys.map(k => locMap[k].city || '').join(' ');
      if (state === 'Florida' && /Boca|Miami|Pompano|Coral Gables|Bal Harbour|Fort Lauderdale/i.test(allCities)) {
        label = 'South Florida';
      } else if (state === 'Florida' && /Palm Beach/i.test(allCities)) {
        label = 'Palm Beach';
      } else if (state === 'California' && /Santa Monica|Beverly|West Hollywood|Los Angeles|Manhattan Beach|Irvine|Newport|Pasadena/i.test(allCities)) {
        label = 'Los Angeles Area';
      } else if (state === 'California' && /San Francisco|Palo Alto|Walnut Creek|Mill Valley|Noe Valley|Sausalito/i.test(allCities)) {
        label = 'Bay Area';
      } else {
        label = topCity;
      }
    }
    // Build label with state abbreviation
    const state = locMap[keys[0]].state || '';
    const stateAbbrs = {'Georgia':'GA','Florida':'FL','California':'CA','Arizona':'AZ','New York':'NY','Texas':'TX','Colorado':'CO','Connecticut':'CT','Tennessee':'TN','New Jersey':'NJ','Maryland':'MD','Illinois':'IL','Oregon':'OR','Washington':'WA','Massachusetts':'MA','Virginia':'VA','Pennsylvania':'PA','North Carolina':'NC','District of Columbia':'DC'};
    const abbr = stateAbbrs[state] || state;
    const fullLabel = label + (abbr ? ', ' + abbr : '');
    const id = label.toLowerCase().replace(/[^a-z0-9]+/g, '_');
    return { id, label: fullLabel, keys, state };
  });
}

let proximityGroups = {}; // state -> [groups]

/* ===== LOCATION MANAGEMENT ===== */
async function initLocations() {
  try {
    const [locResp, geoResp] = await Promise.all([
      fetch('/api/locations').then(r => r.json()),
      fetch('/api/geolocate').then(r => r.json()).catch(() => ({location: 'peachtree', method: 'default'}))
    ]);
    allLocations = locResp.locations || [];

    // Build state map
    const stateMap = {};
    allLocations.forEach(l => {
      if (!stateMap[l.state]) stateMap[l.state] = [];
      stateMap[l.state].push(l);
    });
    Object.values(stateMap).forEach(arr => arr.sort((a, b) => ((a.brand||'') + ' - ' + (a.city||'')).localeCompare((b.brand||'') + ' - ' + (b.city||''))));
    window._stateMap = stateMap;

    // Build proximity groups per state
    proximityGroups = {};
    const manualGroups = {
      'FL': [
        { id: 'miami', label: 'Miami, FL', keys: ['houston_s_north_miami_beach', 'hillstone_coral_gables', 'hillstone_bal_harbour'] },
        { id: 'boca', label: 'Boca / Pompano, FL', keys: ['houston_s_boca_raton', 'houston_s_pompano_beach'] },
        { id: 'palm_beach', label: 'Palm Beach, FL', keys: ['palm_beach_grill', 'honor_bar_palm_beach'] },
      ]
    };
    for (const [st, locs] of Object.entries(stateMap)) {
      if (manualGroups[st]) {
        const locKeys = new Set(locs.map(l => l.key));
        const groups = manualGroups[st]
          .map(g => ({ ...g, keys: g.keys.filter(k => locKeys.has(k)), state: st }))
          .filter(g => g.keys.length >= 2);
        if (groups.length > 0) proximityGroups[st] = groups;
      } else {
        const groups = buildProximityGroups(locs);
        if (groups.length > 0) proximityGroups[st] = groups;
      }
    }

    // Populate the single unified dropdown
    populateLocDropdown();

    // Determine target location from geo-detect
    const nearest = geoResp.location || 'peachtree';
    const targetLoc = allLocations.find(l => l.key === nearest) || allLocations.find(l => l.key === 'peachtree') || allLocations[0];
    const sel = document.getElementById('loc-select');

    if (targetLoc) {
      // Check if target is in a group
      let matched = false;
      for (const groups of Object.values(proximityGroups)) {
        const g = groups.find(g => g.keys.includes(targetLoc.key));
        if (g) { sel.value = 'group:' + g.id; matched = true; break; }
      }
      if (!matched) sel.value = targetLoc.key;
    }
    // Fallback: default to atlanta group
    if (!sel.value) {
      const atlantaOpt = Array.from(sel.options).find(o => o.value.startsWith('group:') && /atlanta/i.test(o.textContent));
      if (atlantaOpt) sel.value = atlantaOpt.value;
      else if (sel.options.length > 0) sel.selectedIndex = 0;
    }

    const detectEl = document.getElementById('loc-detect');
    if (geoResp.method === 'ip' && geoResp.user_city) {
      detectEl.innerHTML = `üìç Detected near <strong>${geoResp.user_city}</strong> (${geoResp.distance_miles} mi) ¬∑ <span onclick="document.getElementById('loc-select').focus()">change</span>`;
    }

    changeLocation(sel.value);
    populateWatchDropdown();
  } catch (e) {
    console.error('Location init failed:', e);
    LOCATIONS = {
      peachtree: {merchant_id:278258, type_id:1681, name:'Peachtree'},
      west_paces: {merchant_id:278259, type_id:1682, name:'West Paces'},
    };
    currentLocationKeys = Object.keys(LOCATIONS);
    loadScanData();
  }
}

function populateLocDropdown() {
  const sel = document.getElementById('loc-select');
  sel.innerHTML = '';
  const stateMap = window._stateMap || {};
  const states = Object.keys(stateMap).sort();

  // Build set of grouped keys per state
  const groupedKeysPerState = {};
  for (const [st, groups] of Object.entries(proximityGroups)) {
    groupedKeysPerState[st] = new Set();
    groups.forEach(g => g.keys.forEach(k => groupedKeysPerState[st].add(k)));
  }

  for (const st of states) {
    const locs = stateMap[st] || [];
    const groups = proximityGroups[st] || [];
    const groupedKeys = groupedKeysPerState[st] || new Set();
    const soloLocs = locs.filter(l => !groupedKeys.has(l.key));

    if (groups.length === 0 && soloLocs.length === 0) continue;

    const optgroup = document.createElement('optgroup');
    optgroup.label = st;

    // Groups first
    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = 'group:' + g.id;
      opt.textContent = 'üìç ' + g.label;
      optgroup.appendChild(opt);
    });

    // Solo locations
    soloLocs.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l.key;
      const dupes = locs.filter(x => x.brand === l.brand && x.city === l.city);
      opt.textContent = dupes.length > 1 ? 'üìç ' + l.name : 'üìç ' + (l.brand || l.name) + ' ‚Äî ' + (l.city || '');
      optgroup.appendChild(opt);
    });

    sel.appendChild(optgroup);
  }
}

function changeLocation(val) {
  if (!val) return;
  LOCATIONS = {};

  if (val.startsWith('group:')) {
    // Find the group
    const groupId = val.slice(6);
    let group = null;
    for (const groups of Object.values(proximityGroups)) {
      group = groups.find(g => g.id === groupId);
      if (group) break;
    }
    if (group) {
      group.keys.forEach(k => {
        const l = allLocations.find(loc => loc.key === k);
        if (l) LOCATIONS[l.key] = {merchant_id: l.merchant_id, type_id: null, name: l.name};
      });
      // Update header for group
      document.getElementById('header-eyebrow').textContent = 'üìç ' + group.label;
      document.getElementById('header-sub').textContent = group.keys.length + ' locations';
      document.title = `${group.label} ‚Äî GetHoustons`;
    }
  } else {
    const l = allLocations.find(loc => loc.key === val);
    if (l) LOCATIONS[l.key] = {merchant_id: l.merchant_id, type_id: null, name: l.name};
    // Update header
    if (l) {
      document.getElementById('header-eyebrow').textContent = l.name;
      document.getElementById('header-sub').textContent = `${l.city}, ${l.state}`;
    }
    document.title = l ? `${l.name} ‚Äî GetHoustons` : 'GetHoustons ‚Äî Reservation Tracker';
  }

  currentLocationKeys = Object.keys(LOCATIONS);

  // Update legend
  const legendEl = document.getElementById('loc-legend');
  const colors = ['pt-dot', 'wp-dot'];
  legendEl.innerHTML = currentLocationKeys.map((k, i) =>
    `<div class="loc-dot"><span class="dot ${colors[i % colors.length]}"></span> ${LOCATIONS[k].name.replace(/Houston's - |Hillstone - /, '')}</div>`
  ).join('');

  // Re-scan
  scanData = null;
  scanTime = null;
  loadScanData();
}

let weekRanges = []; // [{start, end, label, dates}]

function buildWeekRanges(allDates){
  if(!allDates || !allDates.length) return;
  weekRanges = [];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date();
  today.setHours(12,0,0,0);
  const todayDow = today.getDay(); // 0=Sun
  
  // This week: today through Sunday
  const thisSunday = new Date(today);
  thisSunday.setDate(today.getDate() + (7 - todayDow) % 7);
  if(todayDow === 0) thisSunday.setDate(today.getDate()); // if today is Sunday, this week is just today
  
  // Next week: Monday after thisSunday through following Sunday
  const nextMon = new Date(thisSunday);
  nextMon.setDate(thisSunday.getDate() + 1);
  const nextSun = new Date(nextMon);
  nextSun.setDate(nextMon.getDate() + 6);
  
  // Week 3: Monday after nextSun through following Sunday
  const w3Mon = new Date(nextSun);
  w3Mon.setDate(nextSun.getDate() + 1);
  const w3Sun = new Date(w3Mon);
  w3Sun.setDate(w3Mon.getDate() + 6);
  
  const fmt = d => months[d.getMonth()] + ' ' + d.getDate();
  const ranges = [
    {start: today, end: thisSunday, label: 'This Week'},
    {start: nextMon, end: nextSun, label: fmt(nextMon) + ' ‚Äì ' + fmt(nextSun)},
    {start: w3Mon, end: w3Sun, label: fmt(w3Mon) + ' ‚Äì ' + fmt(w3Sun)}
  ];
  
  // Assign dates to each range
  for(const r of ranges){
    r.dates = allDates.filter(ds => {
      const d = new Date(ds + 'T12:00:00');
      return d >= r.start && d <= r.end;
    });
  }
  weekRanges = ranges.filter(r => r.dates.length > 0);
  
  // Render tabs
  const tabsEl = document.getElementById('week-tabs');
  tabsEl.innerHTML = weekRanges.map((r, i) => 
    `<button class="week-tab${i === 0 ? ' active' : ''}" onclick="switchWeek(${i})">${r.label}</button>`
  ).join('');
  
  if(currentWeek >= weekRanges.length) currentWeek = 0;
}
let bookingSlot = null;
let currentUser = null;
let authMode = 'login';

/* ===== HELPERS ===== */
function fmt12(t){const [h,m]=t.split(':').map(Number);const ap=h>=12?'PM':'AM';const h12=h%12||12;return m?`${h12}:${String(m).padStart(2,'0')} ${ap}`:`${h12} ${ap}`;}
function getDayInfo(dateStr){
  const d = new Date(dateStr+'T12:00:00');
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return {
    dayName: days[d.getDay()],
    dayShort: days[d.getDay()].slice(0,3),
    date: d.getDate(),
    month: months[d.getMonth()],
    dow: d.getDay(),
    full: d
  };
}

function isToday(dateStr){
  const now = new Date();
  const d = new Date(dateStr+'T12:00:00');
  return d.toDateString() === now.toDateString();
}

function timeToMinutes(timeStr){
  // "5:00 PM" -> 1020
  const m = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
  if(!m) return 0;
  let h = parseInt(m[1]);
  const min = parseInt(m[2]);
  const ap = m[3].toUpperCase();
  if(ap === 'PM' && h !== 12) h += 12;
  if(ap === 'AM' && h === 12) h = 0;
  return h * 60 + min;
}

function isLunch(timeStr){ const m = timeToMinutes(timeStr); return m >= 720 && m <= 780; } // 12:00 PM ‚Äì 1:00 PM
function isDinner(timeStr){ const m = timeToMinutes(timeStr); return m >= 1080 && m <= 1200; } // 6:00 PM ‚Äì 8:00 PM

/* ===== WEEK TABS ===== */
function switchWeek(week){
  currentWeek = week;
  document.querySelectorAll('.week-tab').forEach((btn, i) => btn.classList.toggle('active', i === week));
  const container = document.getElementById('day-cards');
  container.style.opacity = '0';
  setTimeout(() => { renderDayCards(); container.style.opacity = '1'; }, 150);
}

/* ===== RENDER HERO ===== */
function renderHero(){
  const hero = document.getElementById('hero-card');
  if(!scanData || !scanData.locations){
    hero.innerHTML = '<div class="hero-loading">Loading availability...</div>';
    return;
  }

  // Find next available dinner slot
  const dates = scanData.dates || [];
  let nextSlot = null;

  for(const dateStr of dates){
    for(const locKey of currentLocationKeys){
      const loc = scanData.locations[locKey];
      if(!loc || !loc.days) continue;
      const daySlots = loc.days[dateStr];
      if(!Array.isArray(daySlots)) continue;
      for(const slot of daySlots){
        if(!slot.available || !isDinner(slot.time)) continue;
        const mins = timeToMinutes(slot.time);
        if(!nextSlot || dateStr < nextSlot.date || (dateStr === nextSlot.date && mins < timeToMinutes(nextSlot.time))){
          nextSlot = {date: dateStr, time: slot.time, loc: locKey, locName: LOCATIONS[locKey].name, reserved_ts: slot.reserved_ts, type_id: slot.type_id};
        }
      }
    }
    if(nextSlot) break; // found one on this day, stop
  }

  if(!nextSlot){
    hero.innerHTML = `
      <div class="hero-eyebrow" style="position:relative">Dinner for ${partySize}</div>
      <div class="hero-time" style="font-size:24px">No slots available</div>
      <div class="hero-detail">Check back soon ‚Äî slots open frequently</div>
    `;
    return;
  }

  const info = getDayInfo(nextSlot.date);
  const dayLabel = isToday(nextSlot.date) ? 'Tonight' : info.dayName;

  // Find alt slots on same day
  const alts = [];
  for(const locKey of currentLocationKeys){
    const daySlots = scanData.locations[locKey]?.days[nextSlot.date] || [];
    for(const s of daySlots){
      if(!s.available || !isDinner(s.time)) continue;
      if(locKey === nextSlot.loc && s.time === nextSlot.time) continue;
      alts.push({time: s.time, loc: locKey, locName: LOCATIONS[locKey].name, reserved_ts: s.reserved_ts, type_id: s.type_id});
    }
  }

  let altHtml = '';
  if(alts.length > 0){
    const shown = alts.slice(0,4);
    altHtml = `<div class="hero-alt">Also available: ${shown.map(a =>
      `<a onclick="openBookFromSlot('${nextSlot.date}','${a.time}','${a.loc}','${a.locName.replace(/'/g,"\\'")}',${a.reserved_ts},${a.type_id})">${a.locName} at ${a.time}</a>`
    ).join(' ¬∑ ')}</div>`;
  }

  hero.innerHTML = `
    <div class="hero-eyebrow" style="position:relative">Next Available Dinner for ${partySize}</div>
    <div class="hero-time">${dayLabel} ¬∑ ${nextSlot.time}</div>
    <div class="hero-detail">${nextSlot.locName}</div>
    <button class="hero-btn" onclick="openBookFromSlot('${nextSlot.date}','${nextSlot.time}','${nextSlot.loc}','${nextSlot.locName.replace(/'/g,"\\'")}',${nextSlot.reserved_ts},${nextSlot.type_id})">Book This Slot</button>
    ${altHtml}
  `;
}

/* ===== RENDER DAY CARDS ===== */
function renderDayCards(){
  const container = document.getElementById('day-cards');
  if(!scanData || !scanData.locations){
    container.innerHTML = '<div class="card-skeleton skeleton"></div>'.repeat(3);
    return;
  }

  const allDates = scanData.dates || [];
  const dates = weekRanges.length ? weekRanges[currentWeek]?.dates || [] : allDates.slice(0, 7);
  let html = '';

  for(const dateStr of dates){
    const info = getDayInfo(dateStr);
    const lunchSlots = [];
    const dinnerSlots = [];

    for(const locKey of currentLocationKeys){
      const daySlots = scanData.locations[locKey]?.days[dateStr] || [];
      if(!Array.isArray(daySlots)) continue;
      for(const slot of daySlots){
        if(!slot.available) continue;
        const entry = {time: slot.time, loc: locKey, locName: LOCATIONS[locKey].name, reserved_ts: slot.reserved_ts, type_id: slot.type_id};
        if(isLunch(slot.time)) lunchSlots.push(entry);
        else if(isDinner(slot.time)) dinnerSlots.push(entry);
      }
    }

    // Sort by time
    const sortByTime = (a,b) => timeToMinutes(a.time) - timeToMinutes(b.time) || a.loc.localeCompare(b.loc);
    lunchSlots.sort(sortByTime);
    dinnerSlots.sort(sortByTime);

    const total = lunchSlots.length + dinnerSlots.length;

    if(total === 0){
      html += `
        <div class="day-card">
          <div class="day-card-header">
            <div><span class="day-name">${info.dayName}</span><span class="day-date">${info.month} ${info.date}</span></div>
            <span class="day-badge sold-out">Sold out</span>
          </div>
          <div class="no-slots">No available slots</div>
        </div>`;
      continue;
    }

    const badgeClass = total <= 6 ? 'hot' : '';
    const badgeIcon = total <= 6 ? 'üî• ' : '';

    let sectionsHtml = '';
    if(lunchSlots.length > 0){
      sectionsHtml += `
        <div class="time-section">
          <div class="time-label">Lunch</div>
          <div class="time-pills">${lunchSlots.map(s => pillHtml(dateStr, s)).join('')}</div>
        </div>`;
    }
    if(dinnerSlots.length > 0){
      sectionsHtml += `
        <div class="time-section">
          <div class="time-label">Dinner</div>
          <div class="time-pills">${dinnerSlots.map(s => pillHtml(dateStr, s)).join('')}</div>
        </div>`;
    }
    if(lunchSlots.length === 0 && dinnerSlots.length > 0){
      sectionsHtml += '<div class="no-slots">No lunch slots available</div>';
    }
    if(dinnerSlots.length === 0 && lunchSlots.length > 0){
      sectionsHtml += '<div class="no-slots">No dinner slots available</div>';
    }

    html += `
      <div class="day-card">
        <div class="day-card-header">
          <div><span class="day-name">${info.dayName}</span><span class="day-date">${info.month} ${info.date}</span></div>
          <span class="day-badge ${badgeClass}">${badgeIcon}${total} slot${total!==1?'s':''}</span>
        </div>
        ${sectionsHtml}
      </div>`;
  }

  container.innerHTML = html;
}

function pillHtml(dateStr, s){
  const pillClasses = ['pt', 'wp'];
  const idx = currentLocationKeys.indexOf(s.loc);
  const cls = pillClasses[idx % pillClasses.length];
  const label = currentLocationKeys.length > 1 ? s.time + ' ¬∑ ' + s.locName.replace(/Houston's - |Hillstone - /, '') : s.time;
  const safeName = s.locName.replace(/'/g, "\\'");
  return `<span class="pill ${cls}" onclick="openBookFromSlot('${dateStr}','${s.time}','${s.loc}','${safeName}',${s.reserved_ts},${s.type_id})" title="${s.locName}">${label}</span>`;
}

/* ===== BOOKING ===== */
function openBookFromSlot(dateStr, time, locKey, locName, reserved_ts, type_id){
  const info = getDayInfo(dateStr);
  bookingSlot = {date:dateStr, time, loc:locKey, locName, reserved_ts, type_id, merchant_id: LOCATIONS[locKey].merchant_id};

  document.getElementById('book-modal-loc').textContent = locName;
  document.getElementById('book-modal-datetime').textContent = `${info.dayName}, ${info.month} ${info.date} at ${time}`;
  document.getElementById('book-modal-party').textContent = `Party of ${partySize}`;
  document.getElementById('book-error').style.display = 'none';
  document.getElementById('book-success').style.display = 'none';
  document.getElementById('book-actions').style.display = 'flex';
  document.getElementById('book-form').style.display = 'grid';

  // Pre-fill from logged-in user
  if(currentUser){
    const parts = (currentUser.name||'').split(' ');
    document.getElementById('book-first').value = parts[0]||'';
    document.getElementById('book-last').value = parts.slice(1).join(' ')||'';
    document.getElementById('book-email').value = currentUser.email||'';
  }

  document.getElementById('book-modal').classList.add('open');
}

function closeBookModal(){
  document.getElementById('book-modal').classList.remove('open');
  bookingSlot = null;
}

async function submitBooking(){
  if(!bookingSlot) return;
  const first = document.getElementById('book-first').value.trim();
  const last = document.getElementById('book-last').value.trim();
  const email = document.getElementById('book-email').value.trim();
  const phone = document.getElementById('book-phone').value.trim().replace(/\D/g,'');

  if(!first||!last){showBookError('First and last name required');return;}
  if(!email){showBookError('Email required');return;}
  if(!phone||phone.length<10){showBookError('Valid phone number required');return;}

  const btn = document.getElementById('book-submit-btn');
  btn.disabled = true; btn.textContent = 'Booking...';
  document.getElementById('book-error').style.display = 'none';

  try{
    const payload = {
      merchant_id: bookingSlot.merchant_id,
      party_size: partySize,
      reserved_ts: bookingSlot.reserved_ts,
      name: `${first} ${last}`,
      first_name: first, last_name: last,
      email, phone,
      country_code: 'US',
      reservation_type_id: bookingSlot.type_id,
      source: 'web',
      marketing_opt_in: false
    };
    const resp = await fetch('/api/book', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const data = await resp.json();
    if(resp.ok && data.party){
      const info = getDayInfo(bookingSlot.date);
      document.getElementById('book-success-msg').textContent = `${bookingSlot.locName} ¬∑ ${bookingSlot.time} ¬∑ ${info.dayName}, ${info.month} ${info.date} ¬∑ Party of ${partySize}`;
      document.getElementById('book-form').style.display = 'none';
      document.getElementById('book-success').style.display = 'block';
      document.getElementById('book-success').parentElement.style.display = 'block';
      setTimeout(() => loadScanData(), 2000);
    } else {
      showBookError(data.message || data.error || 'Booking failed ‚Äî slot may have been taken');
      btn.disabled = false; btn.textContent = 'Book Now';
    }
  }catch(e){
    showBookError('Network error ‚Äî try again');
    btn.disabled = false; btn.textContent = 'Book Now';
  }
}

function showBookError(msg){
  const el = document.getElementById('book-error');
  el.textContent = msg; el.style.display = 'block';
}

/* ===== PARTY SIZE ===== */
function changeParty(size){
  partySize = size;
  document.querySelectorAll('.party-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.textContent) === size);
  });
  // Show loading
  document.getElementById('day-cards').style.opacity = '.4';
  loadScanData();
}

/* ===== ALERTS (removed from UI) ===== */

/* ===== DATA LOADING ===== */
async function loadScanData(){
  try{
    document.getElementById('scan-status').innerHTML = '<span class="scan-dot"></span>Scanning...';
    const resp = await fetch(`/api/availability?party_size=${partySize}&days=21`, {signal: AbortSignal.timeout(90000)});
    scanData = await resp.json();
    scanTime = scanData.scanned_at;
    buildWeekRanges(scanData.dates || []);
    document.getElementById('day-cards').style.opacity = '1';
    renderHero();
    renderDayCards();
    updateScanStatus();
  }catch(e){
    console.error('Scan error:', e);
    document.getElementById('day-cards').style.opacity = '1';
    document.getElementById('scan-status').innerHTML = '‚ö†Ô∏è Error loading ‚Äî <a onclick="loadScanData()" style="cursor:pointer">retry</a>';
  }
}

function updateScanStatus(){
  if(!scanTime) return;
  const ago = Math.round((Date.now() - new Date(scanTime).getTime()) / 60000);
  document.getElementById('scan-status').innerHTML = `<span class="scan-dot"></span>Live ‚Äî last scanned ${ago < 1 ? 'just now' : ago + ' min ago'}`;
}

/* loadAlertCount removed */

/* ===== GOOGLE SIGN-IN ===== */
async function _submitPendingWatch(){
  const pw = window._pendingWatch;
  if(!pw) return;
  window._pendingWatch = null;
  const token = localStorage.getItem('houstons_token');
  try{
    const resp = await fetch('/api/watches',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(pw)});
    const data = await resp.json();
    if(data.success){
      showToast('üîî Watch created! We\'ll notify you when a slot opens.');
      loadMyWatches();
    } else { showToast(data.error||'Failed to create watch','error'); }
  }catch(e){ showToast('Network error creating watch','error'); }
}
function handleGoogleSignIn(response){
  fetch('/api/auth/google', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({credential: response.credential})
  })
  .then(r => r.json())
  .then(data => {
    if(data.error){showToast(data.error, 'error'); return;}
    localStorage.setItem('houstons_token', data.token);
    currentUser = data.user;
    showLoggedIn();
    document.getElementById('auth-dropdown').classList.remove('open');
    _submitPendingWatch();
  })
  .catch(e => showToast('Sign-in failed', 'error'));
}

/* ===== AUTH ===== */
function toggleAuthModal(){
  document.getElementById('auth-dropdown').classList.toggle('open');
}
function toggleAuthMode(){
  authMode = authMode === 'login' ? 'signup' : 'login';
  document.getElementById('auth-title').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
  document.getElementById('auth-submit-btn').textContent = authMode === 'login' ? 'Sign In' : 'Sign Up';
  document.getElementById('auth-name-field').style.display = authMode === 'signup' ? 'block' : 'none';
  document.getElementById('auth-toggle').innerHTML = authMode === 'login'
    ? "Don't have an account? <strong>Sign up</strong>"
    : "Already have an account? <strong>Sign in</strong>";
  document.getElementById('auth-error').style.display = 'none';
}
async function submitAuth(){
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-error');
  errEl.style.display = 'none';
  const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/signup';
  const body = {email, password};
  if(authMode === 'signup') body.name = document.getElementById('auth-name').value.trim();
  try{
    const resp = await fetch(endpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    const data = await resp.json();
    if(data.error){errEl.textContent = data.error; errEl.style.display = 'block'; return;}
    localStorage.setItem('houstons_token', data.token);
    currentUser = data.user;
    showLoggedIn();
    _submitPendingWatch();
  }catch(e){errEl.textContent = 'Connection error'; errEl.style.display = 'block';}
}
function showLoggedIn(){
  document.getElementById('auth-form-view').style.display = 'none';
  document.getElementById('auth-user-view').style.display = 'block';
  document.getElementById('auth-user-name').textContent = currentUser.name;
  document.getElementById('auth-user-email').textContent = currentUser.email;
  const avatar = document.getElementById('auth-avatar');
  if(currentUser.picture){avatar.src = currentUser.picture; avatar.style.display = 'block';}
  else{avatar.style.display = 'none';}
  document.getElementById('btn-auth').classList.add('logged-in');
  updateProfileButton();
  loadUserAlerts();
  loadMyWatches();
}
function showLoggedOut(){
  document.getElementById('auth-form-view').style.display = 'block';
  document.getElementById('auth-user-view').style.display = 'none';
  _cachedWatches = [];
  document.getElementById('btn-auth').textContent = 'üë§ Sign In';
  document.getElementById('btn-auth').classList.remove('logged-in');
  document.getElementById('user-alerts-list').innerHTML = '';
  const ws = document.getElementById('watches-section'); if(ws) ws.style.display = 'none';
  currentUser = null;
}
async function doLogout(){
  const token = localStorage.getItem('houstons_token');
  if(token){ try{await fetch('/api/auth/logout',{method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}})}catch(e){} }
  localStorage.removeItem('houstons_token');
  showLoggedOut();
}
let _cachedWatches = [];
function updateProfileButton(){
  const btn = document.getElementById('btn-auth');
  if(!currentUser){btn.textContent='üë§ Sign In';return;}
  const name = currentUser.name.split(' ')[0];
  const count = _cachedWatches.length;
  btn.textContent = count > 0 ? `üë§ ${name} (${count})` : `üë§ ${name}`;
}
async function loadUserAlerts(){
  const token = localStorage.getItem('houstons_token');
  if(!token) return;
  try{
    // Load watches for dropdown
    const wResp = await fetch('/api/watches',{headers:{'Authorization':'Bearer '+token}});
    const wData = await wResp.json();
    _cachedWatches = (wData.watches||[]);
    updateProfileButton();

    const list = document.getElementById('user-alerts-list');
    let html = '';

    if(_cachedWatches.length > 0){
      html += '<div style="font-size:12px;font-weight:600;color:var(--gold-light);margin-bottom:8px">Active Watches</div>';
      html += _cachedWatches.map(w => {
        const loc = allLocations.find(l=>l.key===w.location_key);
        const locName = loc ? loc.name : w.location_key;
        const info = getDayInfo(w.target_date);
        const status = w.auto_book ? '‚ö° Auto-book' : 'üëÄ Watching...';
        return `<div style="background:#ffffff08;border:1px solid #ffffff12;border-radius:8px;padding:10px 12px;margin-bottom:6px">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:13px;font-weight:600;color:#eee">${locName}</div>
              <div style="font-size:11px;color:var(--dim);margin-top:2px">${info.dayName}, ${info.month} ${info.date} ¬∑ ${fmt12(w.time_start)}‚Äì${fmt12(w.time_end)}</div>
              <div style="font-size:11px;color:${w.auto_book?'var(--gold-light)':'#8b8'};;margin-top:2px">${status}</div>
            </div>
            <button onclick="cancelWatchFromDropdown(${w.id})" style="background:none;border:1px solid #ffffff20;color:#f88;font-size:11px;padding:3px 8px;border-radius:4px;cursor:pointer">‚úï</button>
          </div>
        </div>`;
      }).join('');
    }

    // Also load alerts
    const resp = await fetch('/api/auth/alerts',{headers:{'Authorization':'Bearer '+token}});
    const data = await resp.json();
    if(data.alerts&&data.alerts.length>0){
      html += data.alerts.map(a => `<div class="user-alert-item"><strong>${a.preferred_date||'Any date'}</strong> ¬∑ ${a.preferred_time||'Any time'} ¬∑ ${a.party_size} guests</div>`).join('');
    }

    if(!html){html='<div style="text-align:center;color:var(--dim);font-size:12px;padding:12px">No watches or alerts</div>';}
    list.innerHTML = html;
  }catch(e){}
}
async function cancelWatchFromDropdown(id){
  const token = localStorage.getItem('houstons_token');
  try{
    await fetch('/api/watches/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
    loadUserAlerts();
    loadMyWatches();
    showToast('Watch cancelled');
  }catch(e){}
}
async function checkAuth(){
  const token = localStorage.getItem('houstons_token');
  if(!token) return;
  try{
    const resp = await fetch('/api/auth/me',{headers:{'Authorization':'Bearer '+token}});
    const data = await resp.json();
    if(data.user){currentUser = data.user; showLoggedIn();}
    else localStorage.removeItem('houstons_token');
  }catch(e){localStorage.removeItem('houstons_token');}
}

// Close dropdown on outside click
document.addEventListener('click', e => {
  const corner = document.getElementById('auth-corner');
  if(corner && !corner.contains(e.target)) document.getElementById('auth-dropdown').classList.remove('open');
});

/* ===== WATCHES ===== */
let watchContext = null; // {locationKey, date}

function openWatchModal(locationKey, dateStr){
  if(!currentUser){
    toggleAuthModal();
    showToast('Sign in to watch slots', 'error');
    return;
  }
  watchContext = {locationKey, date: dateStr};
  // Populate location dropdown
  const sel = document.getElementById('watch-location');
  sel.innerHTML = '';
  for(const key of currentLocationKeys){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = LOCATIONS[key].name;
    if(key === locationKey) opt.selected = true;
    sel.appendChild(opt);
  }
  document.getElementById('watch-date').value = dateStr;
  document.getElementById('watch-party').value = partySize;
  document.getElementById('watch-auto-book').checked = false;
  document.getElementById('watch-book-fields').classList.remove('show');
  // Pre-fill from user
  if(currentUser){
    const parts = (currentUser.name||'').split(' ');
    document.getElementById('watch-first').value = parts[0]||'';
    document.getElementById('watch-last').value = parts.slice(1).join(' ')||'';
    document.getElementById('watch-phone').value = currentUser.phone||'';
  }
  document.getElementById('watch-submit').disabled = false;
  document.getElementById('watch-submit').textContent = 'Start Watching';
  document.getElementById('watch-modal').classList.add('open');
}
function closeWatchModal(){
  document.getElementById('watch-modal').classList.remove('open');
  watchContext = null;
}
function toggleAutoBook(){
  const checked = document.getElementById('watch-auto-book').checked;
  document.getElementById('watch-book-fields').classList.toggle('show', checked);
}
async function submitWatch(){
  const btn = document.getElementById('watch-submit');
  btn.disabled = true; btn.textContent = 'Creating...';
  const token = localStorage.getItem('houstons_token');
  const autoBook = document.getElementById('watch-auto-book').checked;
  const body = {
    location_key: document.getElementById('watch-location').value,
    party_size: parseInt(document.getElementById('watch-party').value),
    target_date: document.getElementById('watch-date').value,
    time_start: document.getElementById('watch-time-start').value,
    time_end: document.getElementById('watch-time-end').value,
    auto_book: autoBook,
  };
  if(autoBook){
    body.book_first_name = document.getElementById('watch-first').value.trim();
    body.book_last_name = document.getElementById('watch-last').value.trim();
    body.book_phone = document.getElementById('watch-phone').value.trim().replace(/\D/g,'');
    if(!body.book_first_name||!body.book_phone){
      showToast('Name and phone required for auto-book','error');
      btn.disabled = false; btn.textContent = 'Start Watching';
      return;
    }
  }
  try{
    const resp = await fetch('/api/watches',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)});
    const data = await resp.json();
    if(data.success){
      // Save phone to profile for future use
      if(body.book_phone && currentUser && !currentUser.phone){
        currentUser.phone = body.book_phone;
        fetch('/api/profile',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({phone:body.book_phone})}).catch(()=>{});
      }
      closeWatchModal();
      showToast('üëÄ Watch created! We\'ll notify you when a slot opens.');
      loadMyWatches();
    } else {
      showToast(data.error||'Failed to create watch','error');
      btn.disabled = false; btn.textContent = 'Start Watching';
    }
  }catch(e){
    showToast('Network error','error');
    btn.disabled = false; btn.textContent = 'Start Watching';
  }
}
async function loadMyWatches(){
  const token = localStorage.getItem('houstons_token');
  if(!token||!currentUser) return;
  try{
    const resp = await fetch('/api/watches',{headers:{'Authorization':'Bearer '+token}});
    const data = await resp.json();
    const section = document.getElementById('watches-section');
    const list = document.getElementById('watches-list');
    if(!section) return;
    if(!data.watches||data.watches.length===0){section.style.display='none';return;}
    section.style.display='block';
    list.innerHTML = data.watches.map(w => {
      const loc = allLocations.find(l=>l.key===w.location_key);
      const locName = loc ? loc.name : w.location_key;
      const info = getDayInfo(w.target_date);
      return `<div class="watch-item">
        <div class="watch-item-info">
          <div class="watch-item-loc">${locName}</div>
          <div class="watch-item-detail">${info.dayName}, ${info.month} ${info.date} ¬∑ Party of ${w.party_size} ¬∑ ${fmt12(w.time_start)}‚Äì${fmt12(w.time_end)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${w.auto_book ? '<span class="watch-item-badge">Auto-book</span>' : ''}
          <button class="watch-item-cancel" onclick="cancelWatch(${w.id})">Cancel</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){}
}
async function cancelWatch(id){
  const token = localStorage.getItem('houstons_token');
  try{
    await fetch('/api/watches/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
    loadMyWatches();
    loadUserAlerts();
    showToast('Watch cancelled');
  }catch(e){}
}

/* ===== NOTIFY WATCHES (inline section) ===== */
function populateWatchDropdown(){
  const sel = document.getElementById('notify-location');
  if(!sel) return;
  sel.innerHTML = '';
  const stateMap = window._stateMap || {};
  const states = Object.keys(stateMap).sort();
  for(const st of states){
    const locs = stateMap[st] || [];
    if(!locs.length) continue;
    const optgroup = document.createElement('optgroup');
    optgroup.label = st;
    locs.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l.key;
      // Use full name if multiple locations share same brand+city
      const dupes = locs.filter(x => x.brand === l.brand && x.city === l.city);
      const label = dupes.length > 1 ? 'üìç ' + l.name : 'üìç ' + (l.brand || l.name) + ' ‚Äî ' + (l.city || '');
      opt.textContent = label;
      optgroup.appendChild(opt);
    });
    sel.appendChild(optgroup);
  }
  // Default to first current location
  if(currentLocationKeys.length > 0) sel.value = currentLocationKeys[0];
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('notify-date').value = tomorrow.toISOString().split('T')[0];
}

function toggleNotifyAutoBook(){
  const toggle = document.getElementById('notify-auto-toggle');
  toggle.classList.toggle('on');
}

async function submitNotifyWatch(){
  const btn = document.getElementById('notify-cta');
  if(!currentUser){
    window._pendingWatch = {
      location_key: document.getElementById('notify-location').value,
      party_size: parseInt(document.getElementById('notify-party').value),
      target_date: document.getElementById('notify-date').value,
      time_start: window._notifyTimeStart,
      time_end: window._notifyTimeEnd,
      auto_book: document.getElementById('notify-auto-toggle').classList.contains('on'),
    };
    toggleAuthModal();
    showToast('Sign in to start watching slots');
    return;
  }
  btn.disabled = true; btn.textContent = 'Creating...';
  const token = localStorage.getItem('houstons_token');
  const autoBook = document.getElementById('notify-auto-toggle').classList.contains('on');
  const timeStart = window._notifyTimeStart;
  const timeEnd = window._notifyTimeEnd;
  const body = {
    location_key: document.getElementById('notify-location').value,
    party_size: parseInt(document.getElementById('notify-party').value),
    target_date: document.getElementById('notify-date').value,
    time_start: timeStart,
    time_end: timeEnd,
    auto_book: autoBook,
  };
  try{
    const resp = await fetch('/api/watches',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)});
    const data = await resp.json();
    if(data.success){
      showToast('üîî Watch created! We\'ll notify you when a slot opens.');
      loadMyWatches();
      btn.disabled = false; btn.textContent = 'Start Watching';
    } else {
      showToast(data.error||'Failed to create watch','error');
      btn.disabled = false; btn.textContent = 'Start Watching';
    }
  }catch(e){
    showToast('Network error','error');
    btn.disabled = false; btn.textContent = 'Start Watching';
  }
}

// Override loadMyWatches to use new section
const _origLoadMyWatches = loadMyWatches;
loadMyWatches = async function(){
  const token = localStorage.getItem('houstons_token');
  if(!token||!currentUser){
    const s = document.getElementById('watches-section');
    if(s) s.style.display = 'none';
    return;
  }
  try{
    const resp = await fetch('/api/watches',{headers:{'Authorization':'Bearer '+token}});
    const data = await resp.json();
    const section = document.getElementById('watches-section');
    const list = document.getElementById('watches-list');
    if(!section) return;
    if(!data.watches||data.watches.length===0){section.style.display='none';return;}
    section.style.display='block';
    list.innerHTML = data.watches.map(w => {
      const loc = allLocations.find(l=>l.key===w.location_key);
      const locName = loc ? loc.name : w.location_key;
      const info = getDayInfo(w.target_date);
      const statusMap = {watching:'watching',booked:'booked',expired:'expired'};
      const status = statusMap[w.status] || 'watching';
      const statusLabel = status === 'watching' ? 'Watching...' : status === 'booked' ? 'Booked!' : 'Expired';
      return `<div class="watch-card">
        <div class="watch-card-info">
          <div class="watch-card-loc">${locName}</div>
          <div class="watch-card-detail">${info.dayName}, ${info.month} ${info.date} ¬∑ Party of ${w.party_size} ¬∑ ${fmt12(w.time_start)}‚Äì${fmt12(w.time_end)}</div>
          <div style="margin-top:4px;display:flex;gap:6px;align-items:center">
            <span class="watch-status ${status}">${status==='watching'?'<span class="watch-pulse"></span>':''}${statusLabel}</span>
            ${w.auto_book ? '<span class="watch-autobook-badge">ü§ñ Auto-book enabled</span>' : ''}
          </div>
        </div>
        <div class="watch-card-right">
          <button class="watch-card-cancel" onclick="cancelWatch(${w.id})" title="Cancel watch">‚úï</button>
        </div>
      </div>`;
    }).join('');
  }catch(e){}
};

/* ===== INIT ===== */
document.getElementById('footer-year').textContent = new Date().getFullYear();
checkAuth();
initLocations();
/* loadAlertCount() removed */

// Auto-refresh
setInterval(loadScanData, 5*60*1000);
setInterval(updateScanStatus, 30*1000);

/* ===== FEEDBACK ===== */
function openFeedbackModal(){
  document.getElementById('fb-message').value = '';
  document.getElementById('fb-contact').value = currentUser ? currentUser.email : '';
  document.getElementById('fb-submit').disabled = false;
  document.getElementById('fb-submit').textContent = 'Send';
  document.getElementById('feedback-modal').classList.add('open');
}
function closeFeedbackModal(){
  document.getElementById('feedback-modal').classList.remove('open');
}
async function submitFeedback(){
  const message = document.getElementById('fb-message').value.trim();
  if(!message){showToast('Please enter a message','error');return;}
  const btn = document.getElementById('fb-submit');
  btn.disabled = true; btn.textContent = 'Sending...';
  try{
    const resp = await fetch('/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      message, contact: document.getElementById('fb-contact').value.trim()
    })});
    const data = await resp.json();
    if(data.success){closeFeedbackModal();showToast('Thanks for your feedback! üôè');}
    else{showToast(data.error||'Failed to send','error');btn.disabled=false;btn.textContent='Send';}
  }catch(e){showToast('Network error','error');btn.disabled=false;btn.textContent='Send';}
}
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type==='error'?' error':'');
  setTimeout(()=>t.className='toast',3000);
}

/* ===== ADMIN FEEDBACK ===== */
async function loadAdminFeedback(){
  const token = localStorage.getItem('houstons_token');
  if(!token) return;
  try{
    const resp = await fetch('/api/admin/feedback',{headers:{'Authorization':'Bearer '+token}});
    const data = await resp.json();
    if(data.error) return;
    const section = document.getElementById('admin-feedback');
    const list = document.getElementById('admin-feedback-list');
    if(!data.feedback||data.feedback.length===0){section.style.display='none';return;}
    section.style.display = 'block';
    list.innerHTML = data.feedback.map(f => `
      <div class="fb-item">
        <div class="fb-msg">${escHtml(f.message)}</div>
        <div class="fb-meta">
          <span>üìÖ ${f.timestamp||'‚Äî'}</span>
          ${f.contact?`<span>üìß ${escHtml(f.contact)}</span>`:''}
          ${f.ip?`<span>üåê ${f.ip}</span>`:''}
        </div>
      </div>
    `).join('');
  }catch(e){}
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}

// Load admin feedback when logged in
const _origShowLoggedIn = showLoggedIn;
showLoggedIn = function(){_origShowLoggedIn(); loadAdminFeedback();};

// Close modals on Escape
document.addEventListener('keydown', e => {if(e.key==='Escape'){closeBookModal();closeFeedbackModal();closeWatchModal();}});
document.getElementById('book-modal').addEventListener('click', e => {if(e.target===document.getElementById('book-modal')) closeBookModal()});
document.getElementById('feedback-modal').addEventListener('click', e => {if(e.target===document.getElementById('feedback-modal')) closeFeedbackModal()});
</script>
</body>
</html>
